<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru's Drone</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0..1,0" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* =========================================
           DESIGN TOKENS (MD3 DARK)
           ========================================= */
        :root {
            --md-sys-color-background: #101418;
            --md-sys-color-surface: #191c20;
            --md-sys-color-surface-container: #1f2329;
            --md-sys-color-surface-container-high: #292e36;
            
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #062e6f;
            --md-sys-color-primary-container: #23468e;
            --md-sys-color-on-primary-container: #d7e3ff;
            
            --md-sys-color-secondary-container: #3e4759;
            
            --md-sys-color-outline: #8e9199;
            --md-sys-color-outline-variant: #44474f;
            
            --text-main: #e1e2e6;
            --text-muted: #c4c7c5;

            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .nav-rail {
            width: 80px;
            background: var(--md-sys-color-surface);
            display: flex; flex-direction: column; align-items: center;
            padding: 24px 0; border-right: 1px solid var(--md-sys-color-outline-variant);
            z-index: 20;
        }

        .nav-fab {
            width: 56px; height: 56px; border-radius: 16px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: grid; place-items: center; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-bottom: 30px;
            transition: 0.2s;
        }
        .nav-fab:hover { transform: scale(1.05); }

        .nav-item {
            width: 56px; height: 32px; border-radius: 16px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 24px; color: var(--md-sys-color-outline);
            cursor: pointer; transition: 0.2s; gap: 4px;
        }
        .nav-item.active {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        .nav-item span { font-size: 24px; }
        .nav-label { font-size: 10px; font-weight: 500; }

        /* --- MAIN LAYOUT --- */
        .main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }

        .top-bar {
            height: 64px; padding: 0 24px;
            display: flex; align-items: center; justify-content: space-between;
            background: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        .app-title { font-family: 'Google Sans'; font-size: 20px; font-weight: 500; }

        /* --- VIEWS --- */
        .view-section {
            display: none; flex: 1; padding: 24px; overflow: hidden;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD GRID */
        .dashboard-grid {
            display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: auto 1fr; 
            gap: 24px; height: 100%;
        }

        /* CARDS */
        .card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-lg); padding: 20px;
            display: flex; flex-direction: column;
        }
        .stats-row { grid-column: span 2; display: flex; gap: 16px; }
        .stat-card {
            flex: 1; background: var(--md-sys-color-surface-container);
            padding: 16px; border-radius: var(--radius-lg);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .stat-value { font-family: 'Google Sans'; font-size: 28px; color: var(--text-main); }
        .stat-label { font-size: 12px; color: var(--md-sys-color-outline); font-weight: 500; }

        /* MAPA */
        .map-wrapper {
            flex: 1; background: #000; border-radius: var(--radius-lg);
            position: relative; overflow: hidden; border: 1px solid var(--md-sys-color-outline-variant);
        }
        .leaflet-container { background: #101418; }

        /* LISTA */
        .list-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            font-family: 'Google Sans'; font-size: 18px;
        }
        .drone-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .drone-item {
            background: var(--md-sys-color-surface-container-high);
            padding: 16px; border-radius: var(--radius-md);
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .drone-item:hover { background: #333840; }
        .drone-item.active { border-color: var(--md-sys-color-primary); background: #252a33; }

        /* RELATÓRIOS (Reports View) */
        .table-container {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-lg); overflow: hidden; flex: 1;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--md-sys-color-outline-variant); }
        th { background: rgba(255,255,255,0.05); color: var(--md-sys-color-primary); font-weight: 500; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* CONFIGURAÇÕES (Settings View) */
        .settings-container { max-width: 800px; margin: 0 auto; width: 100%; }
        .setting-item {
            background: var(--md-sys-color-surface-container);
            padding: 20px; border-radius: var(--radius-md);
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        /* Slider Custom */
        input[type=range] { width: 200px; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--md-sys-color-primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal {
            background: var(--md-sys-color-surface-container-high);
            width: 400px; padding: 24px; border-radius: 28px;
            transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        .md-input {
            width: 100%; padding: 14px; background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant); border-radius: 8px;
            color: white; margin-bottom: 16px; outline: none;
        }
        .btn-row { display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; }
        .btn-text { background: transparent; color: var(--md-sys-color-primary); }
        .btn-fill { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }

    </style>
</head>
<body>

    <nav class="nav-rail">
        <div class="nav-fab" onclick="app.openNewTask()" title="Nova Missão">
            <span class="material-symbols-rounded">add</span>
        </div>
        
        <div class="nav-item active" onclick="app.nav('dashboard', this)">
            <span class="material-symbols-rounded">grid_view</span>
            <span class="nav-label">Painel</span>
        </div>
        <div class="nav-item" onclick="app.nav('map', this)">
            <span class="material-symbols-rounded">map</span>
            <span class="nav-label">Mapa</span>
        </div>
        <div class="nav-item" onclick="app.nav('reports', this)">
            <span class="material-symbols-rounded">description</span>
            <span class="nav-label">Logs</span>
        </div>
        <div class="nav-item" onclick="app.nav('settings', this)">
            <span class="material-symbols-rounded">settings</span>
            <span class="nav-label">Ajustes</span>
        </div>
    </nav>

    <main class="main">
        <header class="top-bar">
            <div class="app-title" id="page-title">Painel de Controle</div>
            <div style="width: 40px; height: 40px; background: var(--md-sys-color-primary); color: #000; border-radius: 50%; display: grid; place-items: center; font-weight: bold;">G</div>
        </header>

        <div id="view-dashboard" class="view-section active">
            <div class="dashboard-grid">
                
                <div class="stats-row">
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color:var(--md-sys-color-primary);">flight_takeoff</span>
                        <div><div class="stat-value" id="val-active">0</div><div class="stat-label">Drones Voando</div></div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color:#a8effa;">package_2</span>
                        <div><div class="stat-value" id="val-del">0</div><div class="stat-label">Entregas</div></div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color:#d7e3ff;">cleaning_services</span>
                        <div><div class="stat-value" id="val-serv">0</div><div class="stat-label">Serviços</div></div>
                    </div>
                    <div class="stat-card">
                        <span class="material-symbols-rounded" style="color:#ffb4ab;">battery_charging_full</span>
                        <div><div class="stat-value">94%</div><div class="stat-label">Bateria Média</div></div>
                    </div>
                </div>

                <div class="map-wrapper">
                    <div id="map-mini" style="width:100%; height:100%;"></div>
                </div>

                <div class="card" style="overflow: hidden;">
                    <div class="list-header">
                        <span>Frota em Operação</span>
                        <span class="material-symbols-rounded">filter_list</span>
                    </div>
                    <div class="drone-list" id="drone-list-ui"></div>
                </div>

            </div>
        </div>

        <div id="view-map" class="view-section">
            <div class="map-wrapper">
                <div id="map-full" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <div id="view-reports" class="view-section">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="font-family: 'Google Sans'; margin:0;">Histórico de Missões</h2>
                <button class="btn btn-text" onclick="alert('Exportando CSV...')">Exportar Dados</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>ID Missão</th><th>Drone</th><th>Tipo</th><th>Status</th><th>Duração</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>#MS-8492</td><td>GD-04</td><td>Entrega</td><td style="color:#a8effa">Concluída</td><td>14 min</td></tr>
                        <tr><td>#MS-8493</td><td>GD-02</td><td>Limpeza</td><td style="color:#ffb4ab">Interrompida</td><td>05 min</td></tr>
                        <tr><td>#MS-8494</td><td>GD-01</td><td>Ronda</td><td style="color:#a8effa">Concluída</td><td>22 min</td></tr>
                        <tr><td>#MS-8495</td><td>GD-03</td><td>Entrega</td><td style="color:#e2e2e6">Em Curso</td><td>--</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="settings-container">
                <h2 style="font-family: 'Google Sans'; margin-bottom: 20px;">Parâmetros de Voo</h2>
                
                <div class="setting-item">
                    <span>Retorno Automático (RTH) se Bateria < 20%</span>
                    <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
                </div>
                
                <div class="setting-item">
                    <span>Evitar Zonas de Exclusão Aérea (NFZ)</span>
                    <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
                </div>

                <div class="setting-item">
                    <span>Altitude de Cruzeiro (Metros)</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="alt-val">120m</span>
                        <input type="range" min="50" max="150" value="120" oninput="document.getElementById('alt-val').innerText = this.value + 'm'">
                    </div>
                </div>

                <div class="setting-item">
                    <span>Velocidade Máxima (km/h)</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="spd-val">60km/h</span>
                        <input type="range" min="20" max="80" value="60" oninput="document.getElementById('spd-val').innerText = this.value + 'km/h'">
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="modal-overlay" id="task-modal">
        <div class="modal">
            <h2 style="margin-bottom: 20px; font-family: 'Google Sans';">Nova Missão</h2>
            <select class="md-input" id="task-type">
                <option value="delivery">Entrega Expressa</option>
                <option value="service">Limpeza de Fachada</option>
                <option value="inspection">Ronda de Segurança</option>
            </select>
            <input type="text" class="md-input" placeholder="Coordenadas ou Endereço">
            <div class="btn-row">
                <button class="btn btn-text" onclick="app.closeModal()">Cancelar</button>
                <button class="btn btn-fill" onclick="app.deployDrone()">Iniciar Voo</button>
            </div>
        </div>
    </div>

    <script>
        class DroneApp {
            constructor() {
                // Mock Data
                this.drones = [
                    { id: 'GD-01', status: 'delivery', bat: 78, lat: -23.5505, lng: -46.6333, task: 'Entrega #842' },
                    { id: 'GD-02', status: 'service', bat: 45, lat: -23.5550, lng: -46.6400, task: 'Limpeza Torre A' },
                    { id: 'GD-03', status: 'idle', bat: 100, lat: -23.5489, lng: -46.6388, task: 'Base' },
                    { id: 'GD-04', status: 'delivery', bat: 92, lat: -23.5600, lng: -46.6500, task: 'Entrega #845' },
                    { id: 'GD-05', status: 'idle', bat: 12, lat: -23.5520, lng: -46.6350, task: 'Base' }
                ];

                this.maps = {}; // Armazena instâncias dos mapas
                this.markers = { mini: {}, full: {} }; // Marcadores por mapa

                this.dom = {
                    views: {
                        dashboard: document.getElementById('view-dashboard'),
                        map: document.getElementById('view-map'),
                        reports: document.getElementById('view-reports'),
                        settings: document.getElementById('view-settings')
                    },
                    navItems: document.querySelectorAll('.nav-item'),
                    title: document.getElementById('page-title'),
                    list: document.getElementById('drone-list-ui'),
                    modal: document.getElementById('task-modal'),
                    stats: {
                        active: document.getElementById('val-active'),
                        del: document.getElementById('val-del'),
                        serv: document.getElementById('val-serv')
                    }
                };

                this.init();
            }

            init() {
                // Inicializa mapa pequeno (sempre visível no dash)
                this.initMap('mini-map', 'mini');
                this.renderList();
                this.updateStats();
                this.startSimulation();
            }

            // --- NAVEGAÇÃO SPA ---
            nav(viewId, el) {
                // Atualiza Sidebar
                this.dom.navItems.forEach(item => item.classList.remove('active'));
                if (el) el.classList.add('active');

                // Atualiza Views
                Object.values(this.dom.views).forEach(v => v.classList.remove('active'));
                this.dom.views[viewId].classList.add('active');

                // Atualiza Título
                const titles = {
                    'dashboard': 'Painel de Controle',
                    'map': 'Mapa Tático Global',
                    'reports': 'Relatórios Operacionais',
                    'settings': 'Configurações de Sistema'
                };
                this.dom.title.innerText = titles[viewId];

                // Se abriu o mapa full, inicializa ou redimensiona
                if (viewId === 'map') {
                    setTimeout(() => {
                        if (!this.maps.full) this.initMap('map-full', 'full');
                        else this.maps.full.invalidateSize();
                    }, 100);
                }
            }

            // --- MAPA ---
            initMap(elemId, key) {
                const map = L.map(elemId, { zoomControl: false }).setView([-23.5505, -46.6333], 14);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19
                }).addTo(map);

                this.maps[key] = map;
                this.updateMarkers(key);
            }

            updateMarkers(key) {
                const map = this.maps[key];
                if (!map) return;

                this.drones.forEach(d => {
                    const color = d.status === 'delivery' ? '#a8c7fa' : d.status === 'service' ? '#d0bcff' : '#8e9199';
                    
                    if (!this.markers[key][d.id]) {
                        const icon = L.divIcon({
                            className: 'custom-icon',
                            html: `<span class="material-symbols-rounded" style="color:${color}; font-size: 24px; text-shadow: 0 0 10px ${color}; transform: rotate(45deg);">flight</span>`,
                            iconSize: [24, 24]
                        });
                        this.markers[key][d.id] = L.marker([d.lat, d.lng], {icon: icon}).addTo(map)
                            .bindPopup(`<b>${d.id}</b><br>${d.task}`);
                    } else {
                        this.markers[key][d.id].setLatLng([d.lat, d.lng]);
                    }
                });
            }

            // --- UI RENDER ---
            renderList() {
                this.dom.list.innerHTML = '';
                this.drones.forEach(d => {
                    const div = document.createElement('div');
                    div.className = `drone-item ${d.status !== 'idle' ? 'active' : ''}`;
                    div.onclick = () => this.flyToDrone(d.id);
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold;">${d.id}</span>
                            <span style="font-size:12px; color:var(--md-sys-color-primary);">${d.status.toUpperCase()}</span>
                        </div>
                        <div style="font-size:12px; color:#aaa; margin-bottom:8px;">${d.task}</div>
                        <div style="height:4px; background:#444; border-radius:2px; overflow:hidden;">
                            <div style="height:100%; width:${d.bat}%; background:${d.bat < 20 ? '#ffb4ab' : '#a8c7fa'};"></div>
                        </div>
                    `;
                    this.dom.list.appendChild(div);
                });
            }

            updateStats() {
                const active = this.drones.filter(d => d.status !== 'idle').length;
                this.dom.stats.active.innerText = active;
                // Simulando contadores fixos para o demo
                this.dom.stats.del.innerText = "42"; 
                this.dom.stats.serv.innerText = "12";
            }

            flyToDrone(id) {
                const d = this.drones.find(x => x.id === id);
                if (d && this.maps.mini) {
                    this.maps.mini.flyTo([d.lat, d.lng], 16);
                    this.markers.mini[id].openPopup();
                }
            }

            // --- SIMULAÇÃO ---
            startSimulation() {
                setInterval(() => {
                    this.drones.forEach(d => {
                        if (d.status !== 'idle') {
                            d.lat += (Math.random() - 0.5) * 0.001;
                            d.lng += (Math.random() - 0.5) * 0.001;
                            if (d.bat > 0) d.bat -= 0.1;
                        }
                    });
                    this.updateMarkers('mini');
                    if (this.maps.full) this.updateMarkers('full');
                }, 1000);
            }

            // --- AÇÕES ---
            openNewTask() { this.dom.modal.classList.add('open'); }
            closeModal() { this.dom.modal.classList.remove('open'); }
            
            deployDrone() {
                const idle = this.drones.find(d => d.status === 'idle');
                if (idle) {
                    const type = document.getElementById('task-type').value;
                    idle.status = type;
                    idle.task = type === 'delivery' ? 'Nova Entrega' : 'Novo Serviço';
                    this.closeModal();
                    this.renderList();
                    this.updateStats();
                    alert('Drone despachado!');
                } else {
                    alert('Sem drones disponíveis.');
                }
            }
        }

        const app = new DroneApp();
    </script>
</body>
</html>